<!DOCTYPE html>

<html>
    <head>
        <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css" rel="stylesheet" type="text/css"/>
        <script src="https://code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
        <!-- Latest compiled and minified CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
        <!-- Latest compiled and minified JavaScript -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
        <script type='text/javascript' src='https://s3.amazonaws.com/mturk-public/externalHIT_v1.js'></script>

        <script>
            STATIC_ROOT = "https://www.pocaguirre.com/static";

            // ============================================================================
            // create question set and state to go through the questions
            // ============================================================================
            var questions = new Array();
            var state = -1;
            var init_time = $.now();

            // change im_urls to your images
            var im_urls = [ STATIC_ROOT + "/images/image_captioning/dog.jpg",
                            STATIC_ROOT + "/images/image_captioning/cat.jpg",
                            STATIC_ROOT + "/images/image_captioning/dog.jpg",
                            STATIC_ROOT + "/images/image_captioning/cat.jpg",
                            STATIC_ROOT + "/images/image_captioning/dog.jpg"];

            // ============================================================================
            // initialize images
            // ============================================================================
            for (i=0; i < im_urls.length; i++){
                var im = new Image();
                var q = new Object();
                im.src = im_urls[i];
                q.im = im;
                q.ans = '';
                q.done = false;
                // TODO: add fields for identifying images here
                questions.push(q);
            }

            // ============================================================================
            // page onload
            // ============================================================================
            $(window).load(function(){
                render_header_button(im_urls);
                $("#dialog-modal" ).dialog({
                  autoOpen: false,
                  height: 250,
                  modal: true,
                buttons: {
                    'ok':function(){
                        $( this ).dialog( "close" );
                    },
                }
                });
                addDialog();
                $( "#dialog-modal" ).hide();
                $('#next').on('click', function(){next();});
                $('#prev').on('click', function(){prev();});
                $("#start-btn").on('click', function (){start();})
                var els = document.getElementsByClassName('instruction-check');
                for (var i = 0; i < els.length; i++) {
                  els[i].onclick = check_all_checks;
                }

            })

            // ================================================================
            // function to control next and previous question
            // ===============================================================
            function next(){
                let ans = $('#description').val();
                if (ans.length > 0){
                    var q = questions[state];
                    // store user input
                    q.ans = ans;
                    if (!check_correct(q)){
                        return -1;
                    }
                }
                if (state < questions.length - 1){
                    state += 1;
                    render_question(state);
                    update_header_buttons(state);
                }else{
                    if (!finish()){
                        return -1;
                    }
                }
            }

            function prev(){
                let ans = $('#description').val();
                if (ans.length > 0){
                    var q = questions[state];
                    // store user input
                    q.ans = ans;
                    if (!check_correct(q)){
                        return -1;
                    }
                }
                if (state > 0){
                    state -= 1;
                    render_question(state);
                } else if (state === 0){
                    state -= 1;
                }
                update_header_buttons(state);
            }

            function update(event){
                var button = event.currentTarget;
                if (button.disabled){
                    return -1;
                }

                if (0 <= state && state < questions.length) {
                    let ans = $('#description').val();
                    if (ans.length > 0){
                        var q = questions[state];
                        // store user input
                        q.ans = ans;
                        if (!check_correct(q)){
                            return -1;
                        }
                    }
                }

                var id = button.id;
                if (id === "inst"){
                    state = -1
                    $("#images").prop('hidden', true);
                    $("#instructions").prop('hidden', false);
                    $("#finish").prop('hidden', true);
                } else if (id === "fin"){
                    $("#images").prop('hidden', true);
                    $("#instructions").prop('hidden', true);
                    $("#finish").prop('hidden', false);
                } else {
                    $("#images").prop('hidden', false);
                    $("#instructions").prop('hidden', true);
                    $("#finish").prop('hidden', true);
                    state = parseInt(id[id.length - 1]) -1;
                    render_question(state);
                }
                update_header_buttons(state);
            }

            function start(){
                state = 0;
                $("#images").prop('hidden', false);
                $("#instructions").prop('hidden', true);
                $("#finish").prop('hidden', true);
                render_question(state);
                update_header_buttons(state);
                $( ".header-btn" ).each(function( index ) {
                    if (index !== 0 && index !== questions.length + 1) {
                        $(this).prop("disabled", false);
                    }
                });
            }

            function finish(){
                for (i=0; i < questions.length; i++){
                    if (questions[i].done === false){
                        render_dialog(9);
                        return false;
                    }
                }
                $("#images").prop('hidden', true);
                $("#instructions").prop('hidden', true);
                $("#finish").prop('hidden', false);
                state += 1;
                update_header_buttons(state);
                $("#dialog-confirm" ).dialog('open');
            }

            function check_correct(question){
                if (question.ans.split(' ').length < 8){
                    render_dialog(7);
                    return false;
                } else {
                    question.done = true;
                    return true;
                }
            }

            function check_all_checks(){
                if ($(".instruction-check:checked").length > 5) {
                    $("#start-btn").prop("disabled", false);
                }
            }
            // ===============================================================
            // rednering question, image, and dialog
            // ==============================================================
            function render_header_button(im_urls){
                $( "#button-header-group" ).append(`<button type="button" id="inst" class="header-btn btn btn-info">Instructions</button>`);
                for (var i=1; i <= im_urls.length; i++){
                    $( "#button-header-group" ).append(`<button type="button" id="image-${i}" class="header-btn btn btn-outline-secondary" disabled>Image ${i}</button>`);
                }
                $( "#button-header-group" ).append(`<button type="button" id="fin" class="header-btn btn btn-outline-secondary" disabled>Finish</button>`);
                $(".header-btn").on('click', function(event){
                    event.stopPropagation();
                    event.stopImmediatePropagation();
                    update(event);
                });
            }

            function render_question(idx){
                q = questions[idx]
                render_im(q.im);
                $('.state-button').show();
                $('#description').show();
                $('#description').css('width', 480);
                $('#description').css('height', 150);
                $('#description').val(q.ans);
            }

            function render_im(im){
                im.height = im.height * 480 / im.width
                im.width = 480;
                var c = $('#canvas')[0]
                if (im.width > im.height){
                    c.width =  480;
                    c.height = im.height * 480 / im.width;
                }else{
                    c.height = 360;
                    c.width = im.width * 360 / im.height
                }
                var ctx=c.getContext("2d");
                ctx.drawImage(im, 0, 0, c.width, c.height);
            }

            function update_header_buttons(activeIdx){
                $( ".header-btn" ).each(function( index ) {
                    let cl;
                    if (index === 0) {
                        $(this).removeClass("btn-info").addClass("btn-outline-info");
                        if (index === activeIdx + 1){
                            $(this).removeClass("btn-outline-info").addClass("btn-info");
                        }
                    } else if (index > questions.length){
                        $(this).removeClass("btn-success").addClass("btn-outline-secondary");
                        if (index === activeIdx + 1){
                            $(this).removeClass("btn-outline-secondary").addClass("btn-success");
                        }
                    } else {
                        $(this).removeClass("btn-secondary btn-outline-secondary btn-success btn-outline-success");
                        if (index === activeIdx + 1){
                            if ( index - 1 < questions.length && questions[index - 1].done){
                                $(this).addClass("btn-success");
                            } else {
                                $(this).addClass("btn-secondary");
                            }
                        } else {
                            if ( index - 1 < questions.length && questions[index - 1].done){
                                $(this).addClass("btn-outline-success");
                            } else {
                                $(this).addClass("btn-outline-secondary");
                            }
                        }
                    }
                });
                for (i=0; i < questions.length; i++){
                    if (questions[i].done === false){
                        return;
                    }
                }
                $("#fin").prop("disabled", false);
            }

            function render_dialog(idx){
                if (idx==1){
                    var text = 'Do not describe unimportant details.';
                }else if(idx == 2){
                    var text = 'Do not describe things that might have happened in the future or past.';
                }else if(idx == 3){
                    var text = 'Do not describe what a person might say.';
                }else if(idx == 4){
                    var text = 'Do not give people proper names.';
                }else if(idx == 5){
                    var text = 'This is the BEST sentence! Please apply the same rule to describe following 3 images.';
                }else if(idx == 6){
                    var text = 'Please includes more details.';
                }else if(idx==7){
                    var text = 'Please enter more than 8 words.';
                }else if(idx==8){
                    var text = 'Error occured when submitting the form, please try again.';
                }else if (idx==9){
                    var text = "Please complete all descriptions.";
                }
                $("#dialog-modal" ).text(text);
                $("#dialog-modal" ).dialog('open');
            }

            function getAnswers(){
                var answers = [];
                for (var i=0; i<questions.length; i++){
                    answers.push({
                        description: questions[i].ans,
                        im_url: im_urls[i]
                    });
                }
                return answers;
            }

            // ===========================================================
            // add dialog for the web page
            // ===========================================================
            function addDialog(){
                $( "#dialog-confirm" ).dialog({
                  autoOpen: false,
                  resizable: false,
                  height:140,
                  modal: true,
                  buttons: {
                    "Yes": function() {
                      $( this ).dialog( "close" );
                      $("#ans").val(JSON.stringify(getAnswers()));
                      // $('#mturk_form').submit();
                    },
                    Cancel: function() {
                      $( this ).dialog( "close" );
                    }
                  }
                });
                $( ".ui-dialog" ).css('position', 'absolute');
            }

            // ===========================================================
            // disable cut and paste on input text
            // ===========================================================
            $(document).ready(function(){
              $(document).on("cut copy paste","#description",function(e) {
                  e.preventDefault();
              });
             });
        </script>
    </head>
    <body>
        <div id="dialog-modal" title="Message"></div>
        <div id="dialog-confirm" title="Save the Result?"></div>
        <div id="welcome-alert">
            <div class="text-center">
                <p class="small">Click on button for more details</p>
                <p>
                    <a class="btn btn-warning" data-bs-toggle="collapse" href="#generalInstructionsTop" role="button" aria-expanded="false" aria-controls="collapseExample">
                    Show/Hide Details
                    </a>
                </p>
            </div>
            <div class="collapse show alert alert-warning" role="alert" id="generalInstructionsTop">
                <p><strong>Motivation:</strong> Your work will help to build smart systems that can automatically describe our visual world to people who are blind.</p>

                <p class="mb-0"><strong>We ask you to:</strong> carefully review images and then describe the image as per the instructions.</p>
                <hr>
                IMPORTANT: Please do not refresh the webpage once you have started working, as you will lose all your progress, and have to start at the beginning.
            </div>
        </div>

        <div class="card text-center">
            <div class="card-header">
                <div id="button-header-group" class="btn-group" role="group" aria-label="Basic outlined example">
                </div>
            </div>
            <div class="card-body">
                <div id="images" hidden>
                    <div class="row">
                        <div class="col-6 text-end">
                            <div style='padding-top:5px'>
                                <canvas id='canvas'></canvas>
                            </div>

                        </div>
                        <div class="col-6 text-start">
                            <div style='display:inline-block;vertical-align:top;font-size:12pt;text-align:left;'>
                                <h style='font-weight:800'>Instructions:</h>
                                <li>Describe all parts of the image that may be <strong style='color:blue'>important to a person who is blind</strong>
                                    <p><em>E.g., imagine how you would describe this image on the phone to a friend</em></p>
                                </li>
                                <li><strong style='color:red'>Do not</strong> speculate about what people in the image might be saying or thinking.</li>
                                <li><strong style='color:red'>Do not</strong> describe things that might have happened in the future or past.</li>
                                <li><strong style='color:red'>Do not</strong> give people proper names.</li>
                                <li><strong style='color:red'>Do not</strong> use more than one sentence.</li>
                                <li>Your description should contain at least <strong style='color:blue'>8 words</strong>.</li>
                                <div style='padding-top:5px'>
                                    <div id='userinput_div'>
    <!--                                    <div id='header' style='font-weight:800; font-size: 14pt; padding-bottom:5px'>-->
    <!--                                        Please decribe the image:-->
    <!--                                    </div>-->
                                        <div id='userinput'>
                                            <textarea id='description'  placeholder='Type here. Do not start the description with:
    - "There is/are ..."
    - "This is / These are ..."
    - "The/This image/picture ..."
    - "It is ..."'>
                                            </textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 text-center">
                            <div class='state-button' style='text-align:;display:inline-block'>
                                <input type='button' id='prev' value='prev'>
                            </div>
                            <div class='state-button' style='text-align:right;display:inline-block'>
                                <input type='button' id='next' value='next'>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="instructions">
                    <div style='display:inline-block;vertical-align:top;font-size:12pt;text-align:left;'>
                        <h style='font-weight:800'>Instructions:</h>
                        <div class="form-check">
                            <input class="form-check-input instruction-check" type="checkbox" value="" id="instruction1">
                            <label class="form-check-label" for="instruction1">
                                Describe all parts of the image that may be <strong style='color:blue'>important to a person who is blind</strong>
                                <p><em>E.g., imagine how you would describe this image on the phone to a friend</em></p>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input instruction-check" type="checkbox" value="" id="instruction2">
                            <label class="form-check-label" for="instruction2">
                            <strong style='color:red'>Do not</strong> speculate about what people in the image might be saying or thinking.
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input instruction-check" type="checkbox" value="" id="instruction3">
                            <label class="form-check-label" for="instruction3">
                            <strong style='color:red'>Do not</strong> describe things that might have happened in the future or past.
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input instruction-check" type="checkbox" value="" id="instruction4">
                            <label class="form-check-label" for="instruction4">
                            <strong style='color:red'>Do not</strong> give people proper names.
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input instruction-check" type="checkbox" value="" id="instruction5">
                            <label class="form-check-label" for="instruction5">
                            <strong style='color:red'>Do not</strong> use more than one sentence.
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input instruction-check" type="checkbox" value="" id="instruction6">
                            <label class="form-check-label" for="instruction6">
                            Your description should contain at least <strong style='color:blue'>8 words</strong>.
                            </label>
                        </div>
                    </div>
                    <div class="text-center">
                        <button id="start-btn" class="btn btn-primary" disabled>start</button>
                    </div>
                </div>
                <div id="finish" hidden>
                    <form name='mturk_form' method='post' id='mturk_form' action='MTURK_FORM_ACTION'>
                        <input type='hidden' value='' name='assignmentId' id='assignmentId'/>
                        <input type='hidden' value='' name='ans' id='ans'/>
                        <input type='submit' id='submitButton' value='Submit' />
                    </form>
                    <script language='Javascript'>turkSetAssignmentID();</script>
                </div>
            </div>
        </div>
    </body>
</html>
